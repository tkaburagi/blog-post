Table of Contents
=================

* [æº–å‚™ã™ã‚‹ã‚‚ã®](#æº–å‚™ã™ã‚‹ã‚‚ã®)
* [ãƒ‡ãƒ¢ã‚¤ãƒ¡ãƒ¼ã‚¸](#ãƒ‡ãƒ¢ã‚¤ãƒ¡ãƒ¼ã‚¸)
* [GKEã‚¯ãƒ©ã‚¹ã‚¿ã®è¨­å®š](#gkeã‚¯ãƒ©ã‚¹ã‚¿ã®è¨­å®š)
* [EKSã‚¯ãƒ©ã‚¹ã‚¿ã®è¨­å®š](#eksã‚¯ãƒ©ã‚¹ã‚¿ã®è¨­å®š)
* [Federationã¨ã¯](#federationã¨ã¯)
* [ã‚¢ãƒ—ãƒªã®ãƒ‡ãƒ—ãƒ­ã‚¤](#ã‚¢ãƒ—ãƒªã®ãƒ‡ãƒ—ãƒ­ã‚¤)
* [ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ãƒ—ãƒ­ã‚­ã‚·ã§ã®ã‚µãƒ¼ãƒ“ã‚¹æ¥ç¶š](#ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ãƒ—ãƒ­ã‚­ã‚·ã§ã®ã‚µãƒ¼ãƒ“ã‚¹æ¥ç¶š)
* [Terminating Gatewayã§ã®ã‚µãƒ¼ãƒ“ã‚¹æ¥ç¶š](#terminating-gatewayã§ã®ã‚µãƒ¼ãƒ“ã‚¹æ¥ç¶š)
    * [Terminatingã®è¨­å®š](#terminatingã®è¨­å®š)
* [Mesh Gatewayã§ã®ã‚µãƒ¼ãƒ“ã‚¹æ¥ç¶š](#mesh-gatewayã§ã®ã‚µãƒ¼ãƒ“ã‚¹æ¥ç¶š)
    * [L7 Traffic Managementã®è¨­å®š](#l7-traffic-managementã®è¨­å®š)
* [Ingress Gatewayã§ã®ã‚µãƒ¼ãƒ“ã‚¹æ¥ç¶š](#ingress-gatewayã§ã®ã‚µãƒ¼ãƒ“ã‚¹æ¥ç¶š)
    * [Ingress Gatewayã®è¨­å®š](#ingress-gatewayã®è¨­å®š)
* [å‚è€ƒãƒªãƒ³ã‚¯](#å‚è€ƒãƒªãƒ³ã‚¯)
      
Consulã®Service Meshã§ã¯

* Sidcar Proxyã§ãƒ¡ãƒƒã‚·ãƒ¥ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å†…ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åŒå£«ã‚’ã¤ãªã
* Mesh Gatewayã§ãƒ¡ãƒƒã‚·ãƒ¥ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯åŒå£«ã‚’ç¹‹ã
* Ingress Gawewayã§å¤–éƒ¨ã®ã‚µãƒ¼ãƒ“ã‚¹ã‹ã‚‰ãƒ¡ãƒƒã‚·ãƒ¥ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã«ã¤ãªã
* Terminating Gatewayã§ãƒ¡ãƒƒã‚·ãƒ¥ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‹ã‚‰å¤–éƒ¨ã®ã‚µãƒ¼ãƒ“ã‚¹ã«ã¤ãªã

ã®ã‚ˆã†ãªã“ã¨ãŒã§ãã¾ã™ã€‚

![](https://blog-kabuctl-run.s3-ap-northeast-1.amazonaws.com/20210126/1.png)

Ingress Gateway, Terminating Gatewayã‚’ä½¿ã†ã“ã¨ã§ã€ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤å‡ºæ¥ãªã„ã‚ˆã†ãªãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ä¸Šã®ã‚µãƒ¼ãƒ“ã‚¹ã‚„ã€ãƒ¬ã‚¬ã‚·ãƒ¼ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«å¯¾ã—ã¦Envoyã‚’ä»‹ã—ã¦ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã‚Šã€ã‚¢ã‚¯ã‚»ã‚¹ã•ã›ãŸã‚Šå‡ºæ¥ã¾ã™ã€‚

ä»Šæ—¥ã¯ã“ã‚Œã‚‰ã‚’çµ„ã¿åˆã‚ã›ãŸãƒ‡ãƒ¢ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚1ã‚¯ãƒ©ã‚¹ã‚¿å†…ã®ã‚µãƒ¼ãƒ“ã‚¹ãƒ¡ãƒƒã‚·ãƒ¥ã®ãƒ‡ãƒ¢ã¯[ã“ã¡ã‚‰](https://github.com/tkaburagi/consul-onecluster-servicemesh) ã‚’å‚è€ƒã«ã—ã¦ãã ã•ã„ã€‚

*Javaã®ã‚³ãƒ¼ãƒ‰ã¯ã‚µãƒ³ãƒ—ãƒ«ãªã®ã§ãã®ã¾ã¾çœŸä¼¼ã—ãªã„ã§ãã ã•ã„ã€‚*

## æº–å‚™ã™ã‚‹ã‚‚ã®

* Public FacingãªK8sã‚¯ãƒ©ã‚¹ã‚¿äºŒã¤
    * ä»Šå›ã¯GKEã¨EKSã‚’ä½¿ã„ã¾ã™ã€‚
* Pivotal Web Servicesã‚¢ã‚«ã‚¦ãƒ³ãƒˆ
    * [Sign-up](https://run.pivotal.io/)
* `aws`, `gcloud`, `eks`, `cf`, `kubectl`, `helm`
    
## ãƒ‡ãƒ¢ã‚¤ãƒ¡ãƒ¼ã‚¸

<kbd>
  <img src="https://github-image-tkaburagi.s3-ap-northeast-1.amazonaws.com/my-github-repo/multicluster-servicemesh.png">
</kbd>    

ã‚¢ãƒ—ãƒªã¯ãã‚Œãã‚Œæ–‡å­—åˆ—ã‚’è¿”ã™ã ã‘ã§ã™ã€‚

* `hashi`, `japan`, `france`: ãã‚Œãã‚Œã‚¢ãƒ—ãƒªåã®æ–‡å­—åˆ—ã‚’è¿”ã™ã€‚
* `corpx`: `japan`, `france`ã¨é€£æºã—ã€`Corp Japan`, `Corp France`ã¨ã„ã†æ–‡å­—åˆ—ã‚’è¿”ã™ã€‚
* `hashicorpx`: `hashi`ã¨`corp`ã¨é€£æºã—ã€`HashiCorp Japan`, `HashiCorp France`ã®æ–‡å­—åˆ—ã‚’è¿”ã™ã€‚
* `ui`: `hashicorpx`ã¨é€£æºã—ã€`HashiCorp JapanğŸ‡¯ğŸ‡µ` `HashiCorp FranceğŸ‡«ğŸ‡·`ã‚’è¡¨ç¤ºã•ã›ã‚‹ã€‚

ä»Šå›ã¯å›³ã®é€šã‚Šã€GKEã‚¯ãƒ©ã‚¹ã‚¿ã«

* äºŒã¤ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—
* Mesh Gatewayã§EKSã‚¯ãƒ©ã‚¹ã‚¿ã¨ç¹‹ãã€
* Ingress Gatewayã§PWSä¸Šã®UIã‚¢ãƒ—ãƒªã‹ã‚‰ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘ã¤ã‘ã€
* Terminating Gatewayã‹ã‚‰GCEä¸Šã®ãƒ¬ã‚¬ã‚·ãƒ¼ã‚¢ãƒ—ãƒªã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™ã€‚

EKSã‚¯ãƒ©ã‚¹ã‚¿ä¸Šã«ã¯
* `japan`, `france`ã¨ã„ã†äºŒã¤ã®ã‚¢ãƒ—ãƒªã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã€
* Consulã®L7 Traffic Routingã§HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãƒ‘ã‚¹ã«å¿œã˜ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æŒ¯ã‚Šåˆ†ã‘ã¾ã™ã€‚

## GKEã‚¯ãƒ©ã‚¹ã‚¿ã®è¨­å®š

```shell script
$ git clone https://github.com/tkaburagi/consul-multicluster-servicemesh
$ helm repo add hashicorp https://helm.releases.hashicorp.com && \
$ helm repo update
```

```shell script
$ cloud container clusters create \
    consul-mesh-gateway-cluster-1 \
    --num-nodes=3
$ gcloud container clusters get-credentials consul-mesh-gateway-cluster-1 --zone asia-northeast1-a --project se-kabu
$ kc apply -f ns.yaml
$ helm install -f helm/consul-values-gke.yaml consul hashicorp/consul  --wait -n multicluster-servicemesh
$ kc get secret consul-federation -o yaml -n multicluster-servicemesh > consul-federation-secret.yaml
```

Helmã®ã‚³ãƒ³ãƒ•ã‚£ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ã€ä»¥ä¸‹ãŒãƒã‚¤ãƒ³ãƒˆã§ã™ã€‚

1. Consul Clientã«å¿…è¦ãªãƒªã‚½ãƒ¼ã‚¹ã‚’Kuberenetesãƒãƒ¼ãƒ‰ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã€‚
```yaml
client:
  enabled: true
```

2. Sidecar Injectionã‚’æœ‰åŠ¹åŒ–ã™ã‚‹ã€‚
```yaml
connectInject:
  enabled: true
  default: true
```

3. Mesh Gatewayã‚’æœ‰åŠ¹ã™ã‚‹ã€‚
```yaml
meshGateway:
  enabled: true
```

4. Ingress Gatewayã‚’æœ‰åŠ¹åŒ–ã™ã‚‹ã€‚Ingress Gatewayã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã®ãƒªã‚½ãƒ¼ã‚¹ã¯`LoadBlarancer`, `ClusterIP`, `NodePort`ã‚’æŒ‡å®šã§ãã¾ã™ã€‚
```yaml
ingressGateways:
  enabled: true
  gateways:
    - name: ingress-gateway
      service:
        type: LoadBalancer
```

5. Terminating Gatewayã‚’æœ‰åŠ¹åŒ–ã™ã‚‹ã€‚
```yaml
terminatingGateways:
  enabled: true
  gateways:
    - name: terminating-gateway
```

6. TLSã®æœ‰åŠ¹åŒ–ã€‚Mesh Gatewayã§Federationã‚’çµ„ã‚€éš›ã«å¿…é ˆã§ã™ã€‚
```yaml
  tls:
    enabled: true
    verify: false
```

7. Federationã®è¨­å®šã€‚Mesh Gatewayã§ãƒãƒ«ãƒã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã®Federationã‚’çµ„ã¿ã¾ã™ã€‚Federationã«ã¤ã„ã¦ã¯ã‚ã¨ã§èª¬æ˜ã—ã¾ã™ã€‚ `Federationã€€Secret`ã«ã¯ç‰‡ç³»ã‚¯ãƒ©ã‚¹ã‚¿ãŒæ¥ç¶šã™ã‚‹ãŸã‚ã®æƒ…å ±ãŒåŒ…å«ã•ã‚Œã¦ãŠã‚Šã€ã“ã‚Œã‚’ç‰‡ç³»ã‚¯ãƒ©ã‚¹ã‚¿ã®ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã«ã‚»ãƒƒãƒˆã—ã¾ã™ã€‚
```yaml
  federation:
    enabled: true
    createFederationSecret: true
```

## EKSã‚¯ãƒ©ã‚¹ã‚¿ã®è¨­å®š

```shell script
$ eksctl create cluster \
    --name=consul-mesh-gateway-cluster-2 \
    --nodes=3 \
    --node-ami=auto \
    --region=ap-northeast-1 \
    --version=1.16
$ aws eks --region ap-northeast-1 update-kubeconfig --name consul-mesh-gateway-cluster-2
$ kc apply -f ns.yaml
$ kc apply -f consul-federation-secret.yaml
$ helm install -f helm/consul-values-eks.yaml consul hashicorp/consul --wait -n multicluster-servicemesh
```

Helmã®ã‚³ãƒ³ãƒ•ã‚£ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ã€ä»¥ä¸‹ãŒãƒã‚¤ãƒ³ãƒˆã§ã™ã€‚(GKEã‚¯ãƒ©ã‚¹ã‚¿ã¨å…±é€šã®ã‚‚ã®ã¯çœç•¥)

1. Federation Secretã®è¨­å®šã€‚GKEã‚µã‚¤ãƒ‰ã§ç”Ÿæˆã€å–å¾—ã—ãŸFederation Secretã‚’ã‚»ãƒƒãƒˆã—ã¾ã™ã€‚ã“ã‚Œã§GKEã‚¯ãƒ©ã‚¹ã‚¿ã¨Mesh Gatewayã‚’ä»‹ã—ã¦Federationã‚’çµ„ã‚€ã“ã¨ãŒã§ãã¾ã™ã€‚
```yaml
  tls:
    enabled: true
    caCert:
      secretName: consul-federation
      secretKey: caCert
    caKey:
      secretName: consul-federation
      secretKey: caKey
  federation:
    enabled: true
```

## Federationã¨ã¯

Federationã¯ã‚‚ã¨ã‚‚ã¨Consulã«ã‚ã‚‹æ©Ÿèƒ½ã§ã€è¤‡æ•°ã®Consulãƒ‡ãƒ¼ã‚¿ã‚»ãƒ³ã‚¿ãƒ¼ã‚’ã‚¸ãƒ§ã‚¤ãƒ³ã•ã›ã€ç›¸äº’é€šä¿¡ã‚’ã™ã‚‹ãŸã‚ã®ã‚‚ã®ã§ã™ã€‚

* Service Meshã§ã‚µãƒ¼ãƒ“ã‚¹é–“ã‚’æ¥ç¶š
* ã‚¯ãƒ©ã‚¹ã‚¿ã«è·¨ã£ãŸIntentions(ACL)ã‚’è¨­å®š
* L7 Routing Ruleã®è¨­å®šã‚’ä¸€å…ƒåŒ–

ãªã©ãŒå‡ºæ¥ã¾ã™ã€‚å¾“æ¥ã¯Consulã‚¯ãƒ©ã‚¹ã‚¿åŒå£«ã‚’LBãªã©ã‚’ä»‹ã—ã¦ç›´æ¥æ¥ç¶šã—ãªã‘ã‚Œã°ã„ã‘ã¾ã›ã‚“ã§ã—ãŸãŒã€Mesh Gatewayã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§Mesh Gatewayã‚’ä»‹ã—ã¦Federationã‚’çµ„ã¿ã“ã¨ãŒå‡ºæ¥ã€ã¨ã¦ã‚‚ç°¡å˜ã«ãªã‚Šã¾ã—ãŸã€‚

## ã‚¢ãƒ—ãƒªã®ãƒ‡ãƒ—ãƒ­ã‚¤

```shell script
$ gcloud container clusters get-credentials consul-mesh-gateway-cluster-1 --zone asia-northeast1-a --project se-kabu
$ kubectl apply -f corp.yaml -n=multicluster-servicemesh
$ kubectl apply -f hashicorpx.yaml -n=multicluster-servicemesh
$ kubectl get all -n=multicluster-servicemesh
```

```shell script
$ aws eks --region ap-northeast-1 update-kubeconfig --name consul-mesh-gateway-cluster-2
$ kubectl apply -f japan.yaml -n=multicluster-servicemesh
$ kubectl apply -f france.yaml -n=multicluster-servicemesh
$ kubectl get all -n=multicluster-servicemesh
```

å…¨éƒ¨`Running`ã«ãªã£ã¦ã°OKã€‚Consul UIã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨å„è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã§è¨­å®šã—ãŸã‚µãƒ¼ãƒ“ã‚¹åã§ã‚µãƒ¼ãƒ“ã‚¹ãŒConsul Service Catalogã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã¯ãšã§ã™ã€‚ã‚µãƒ¼ãƒ“ã‚¹ç™»éŒ²ã‚‚è¨­å®šãƒ™ãƒ¼ã‚¹ã§å‡ºæ¥ã‚‹ãŸã‚ç‰¹ã«ä½œæ¥­ã¯å¿…è¦ãªã„ã§ã™ã€‚

## ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ãƒ—ãƒ­ã‚­ã‚·ã§ã®ã‚µãƒ¼ãƒ“ã‚¹æ¥ç¶š

ã¾ãšã¯å›³ã®`hashicorpx` - `corpx`é–“ã®ã‚¢ãƒ—ãƒªã®æ¥ç¶šã‚’è¦‹ã¦ã„ãã¾ã—ã‚‡ã†ã€‚åŒä¸€ã‚¯ãƒ©ã‚¹ã‚¿å†…ã®ä¸€ç•ªã‚·ãƒ³ãƒ—ãƒ«ãªãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã™ã€‚

`hashcorpx`ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸€éƒ¨ã¯ã“ã¡ã‚‰ã§ã™ã€‚

```yaml
  annotations:
    consul.hashicorp.com/connect-inject: "true"
    consul.hashicorp.com/connect-service-upstreams: "hashi-gce:5000, corpx:5001"
```

`consul.hashicorp.com/connect-inject`ã§ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚’æœ‰åŠ¹åŒ–ã—ã€`consul.hashicorp.com/connect-service-upstreams`ã§ã‚¢ãƒƒãƒ—ã‚¹ãƒˆãƒªãƒ¼ãƒ å…ˆã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’æŒ‡å®šã—ã¦ã„ã¾ã™ã€‚`corpx:5001`ã¨æŒ‡å®šã™ã‚‹ã“ã¨ã§ã€

* Envoyã®5001ãƒãƒ¼ãƒˆã®ãƒªã‚¹ãƒŠãƒ¼ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ã€
* `corpx`ã¨ã„ã†ã‚µãƒ¼ãƒ“ã‚¹åã®ã‚µãƒ¼ãƒ“ã‚¹ã«ã‚¢ãƒƒãƒ—ã‚¹ãƒˆãƒªãƒ¼ãƒ ã•ã‚Œã‚‹

ã¨ã„ã†æ„å‘³ã§ã™ã€‚

ã‚¢ã‚¯ã‚»ã‚¹ã•ã‚Œã‚‹ãŸã‚ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã®ä¸€éƒ¨ã¯ã“ã¡ã‚‰ã§ã™ã€‚

```java
// ~~~
    @GetMapping("/japan")
    public String hashicorpx() {
        URI url1 = new URI("http://127.0.0.1:5001/api/japan");
// ~~~
        String messageFromCorpX = restTemplate.getForEntity(url1, String.class).getBody();
// ~~~
    }
```

ãƒ­ãƒ¼ã‚«ãƒ«ã®ãƒªã‚¹ãƒŠãƒ¼ã«ã‚¢ã‚¯ã‚»ã™ã‚‹ã ã‘ã§ã™ã€‚é€šå¸¸Consulã®ã‚µãƒ¼ãƒ“ã‚¹ã‚«ã‚¿ãƒ­ã‚°ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’åˆ©ç”¨ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ãŒã€ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã«å§”è¨—ã—ã€ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã ã‘ã§OKãªã®ã§å®Ÿè£…ãŒæ¥½ã§ã™ã€‚

`corpx`ã®ã‚¢ãƒ—ãƒªã¯`api/japan`ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’æŒã£ã¦ã„ã¾ã™ã€‚

```java
@GetMapping("/api/japan")
public String japan() {
// ~~~
}
```

## Terminating Gatewayã§ã®ã‚µãƒ¼ãƒ“ã‚¹æ¥ç¶š

æ¬¡ã«`hashicorpx` - `hashi`é–“ã§ã™ã€‚

`hashi`ã¯GCEä¸Šã«ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¦ãŠã‚Šã€ãƒ¬ã‚¬ã‚·ãƒ¼ã‚¢ãƒ—ãƒªã§ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ãŒå‡ºæ¥ãªã„ã‚‚ã®ã¨æ€ã£ã¦ãã ã•ã„ã€‚(å®Ÿéš›ã¯GCEä¸Šã«ã‚‚ãƒ‡ãƒ—ãƒ­ã‚¤å‡ºæ¥ã¾ã™ã€‚)ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ãŒãªã„ã‚µãƒ¼ãƒ“ã‚¹(ãƒ¡ãƒƒã‚·ãƒ¥ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã¸ã®å¤–)ã¸ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã«ã¯Terminating Gatewayã‚’åˆ©ç”¨ã—ã¾ã™ã€‚

ã¾ãšã¯`hashi`ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’Consulã‚µãƒ¼ãƒ“ã‚¹ã‚«ã‚¿ãƒ­ã‚°ã«ç™»éŒ²ã—ã¾ã™ã€‚ã‚µãƒ¼ãƒ“ã‚¹ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’ç™»éŒ²ã™ã‚‹ã“ã¨ã§å¤–éƒ¨ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚‚Consulã®ã‚«ã‚¿ãƒ­ã‚°ã«ç™»éŒ²ã§ãã¾ã™ã€‚

```shell script
$ curl --request PUT --data @terminating-gateway/regist-hashi.json -k $CONSUL_HTTP_ADDR/v1/catalog/register
```

JSONã®ä¸­èº«ã¯ã“ã¡ã‚‰ã§ã™ã€‚ã“ã®ã‚µãƒ¼ãƒ“ã‚¹ã¯`34.84.167.230:8080`ã§ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚ã“ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’`hashi-gce`ã¨ã—ã¦Consulã®ã‚«ã‚¿ãƒ­ã‚°ã«ç™»éŒ²ã—ã¦ã„ã¾ã™ã€‚ã€€

```json
{
  "Node": "Google Compute Engine",
  "Address": "34.84.167.230",
  "NodeMeta": {
    "external-node": "true",
    "external-probe": "true"
  },
  "Service": {
    "ID": "hashi-gce",
    "Service": "hashi-gce",
    "Port": 8080
  }
}
```

`hashicorpx`ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸€éƒ¨ã¯ã“ã¡ã‚‰ã§ã™ã€‚

```yaml
  annotations:
    consul.hashicorp.com/connect-inject: "true"
    consul.hashicorp.com/connect-service-upstreams: "hashi-gce:5000, corpx:5001"
```

`hashi-gce`ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã¯Envoyã®`5000`ãƒãƒ¼ãƒˆã§ãƒªã‚¹ãƒ³ã—ã¦ã„ã¾ã™ã€‚

### Terminatingã®è¨­å®š

Terminating Gatewayã¯ãƒ‡ãƒ—ãƒ­ã‚¤æ¸ˆã¿ã§ã™ãŒã€é–¢é€£ã¥ã‘ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã®è¨­å®šãªã©ã¯ã¾ã ã§ã™ã€‚

```shell script
$ export CONSUL_HTTP_SSL=true
$ export CONSUL_HTTP_SSL_VERIFY=false
$ export CONSUL_HTTP_ADDR=<IP> #GKE
$ consul config write proxy-config/hashi-svc-defaults.hcl
$ consul config write terminating-gateway/terminating-gateway.hcl 
```

å„ãƒ—ãƒ­ã‚­ã‚·ãƒ¼ã«è¨­å®šã™ã‚‹`Configuration Entries`ã‚’é©ç”¨ã—ã¾ã—ãŸã€‚

```hcl
Kind     = "service-defaults"
Name     = "hashi-gce"
Protocol = "http"
```

```hcl
Kind = "terminating-gateway"
Name = "terminating-gateway"

Services = [
  {
    Name = "hashi-gce"
  }
]
```

ã‚µãƒ¼ãƒ“ã‚¹ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®è¨­å®šã‚’è¡Œã„ã€ãã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’Terminating Gatewayã«é–¢é€£ã¥ã‘ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã‚’æŒ‡å®šã—ã¦ã„ã¾ã™ã€‚`hashi-gce`ã¯Terminating Gatewayã®ã‚ã‚‹ã‚¯ãƒ©ã‚¹ã‚¿ã®Consulã®ã‚µãƒ¼ãƒ“ã‚¹ã‚«ã‚¿ãƒ­ã‚°ã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ã“ã‚Œã§Terminating GatewayãŒ`hashi-gce`ã«ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã‚’ãƒ—ãƒ­ã‚­ã‚·ã—ã¾ã™ã€‚

ã‚¢ãƒ—ãƒªã®ã‚½ãƒ¼ã‚¹ã¯ã“ã¡ã‚‰ã§ã™ã€‚

```java
//~~~
@GetMapping("/japan")
public String hashicorpjapan() throws Exception {
    URI url = new URI("http://127.0.0.1:5000/");
//~~~
    String messageFromHashi = restTemplate.getForEntity(url, String.class).getBody();
//~~~
}
```

## Mesh Gatewayã§ã®ã‚µãƒ¼ãƒ“ã‚¹æ¥ç¶š

æ¬¡ã«Mesh Gatewayã§ã™ã€‚å›³ã®é€šã‚Šã€`corpx` - `japan`, `corpx` - `france`é–“ã§ä½¿ã£ã¦ã„ã¾ã™ã€‚ã™ã§ã«Mesh Gatewayã¯ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¦ã„ã‚‹ãŸã‚è¿½åŠ ã®è¨­å®šã¯å¿…è¦ã‚ã‚Šã¾ã›ã‚“ã€‚
`corpx`ã‚¢ãƒ—ãƒªã®è¨­å®šã¯ä»¥ä¸‹ã®ã¨ãŠã‚Šã§ã™ã€‚

```yaml
 annotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "9102"
    consul.hashicorp.com/connect-inject: "true"
    consul.hashicorp.com/connect-service-upstreams: "country-api:5000:dc-2"
```

åˆ¥ã®ãƒ‡ãƒ¼ã‚¿ã‚»ãƒ³ã‚¿ãƒ¼ã«ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã™ã‚‹éš›ã¯`<service_name>:<port>:<dc_name>`ã¨ã—ã¦æŒ‡å®šã—ã¾ã™ã€‚ã‚½ãƒ¼ã‚¹ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

```java
@GetMapping("/api/japan")
public String japan() throws Exception {
    System.out.println("japan");
    URI url = new URI("http://127.0.0.1:5000/api/japan");
    String japan = restTemplate.getForEntity(url, String.class).getBody();
    return "Corp " + japan;
}

@GetMapping(value = "/api/france")
public String france() throws Exception {
    System.out.println("france");
    URI url = new URI("http://127.0.0.1:5000/api/france");
    String france = restTemplate.getForEntity(url, String.class).getBody();
    return "Corp " + france;
}
```

5000ãƒãƒ¼ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã€`api/france`ã¨`api/japan`ã«Pathãƒ™ãƒ¼ã‚¹ã§ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’è¡Œãªã£ã¦ã„ã¾ã™ã€‚

`japan`ã¨`france`ã®ã‚¢ãƒ—ãƒªã¯åˆ¥ã®ã‚µãƒ¼ãƒ“ã‚¹ã§ã™ãŒã€Consulã®L7 Traffic Managementã‚’ä½¿ã†ã“ã¨ã§åŒä¸€ã®Service IDã§Envoyã§Pathãƒ™ãƒ¼ã‚¹ã§ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãŒå‡ºæ¥ã¾ã™ã€‚

ã“ã®è¾ºã®è¨­å®šã‚’ã¿ã¦ã„ãã¾ã™ã€‚

### L7 Traffic Managementã®è¨­å®š

```shell script
$ consul config write proxy-config/japan-svc-defaults.hcl
$ consul config write proxy-config/france-svc-defaults.hcl
$ consul config write proxy-config/country-service-router.hcl
```

`japan`ã¨`france`ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®è¨­å®šã§ã™ã€‚

```hcl
Kind     = "service-defaults"
Name     = "japan"
Protocol = "http"
MeshGateway {
  Mode = "local"
}
```

```hcl
Kind     = "service-defaults"
Name     = "france"
Protocol = "http"
MeshGateway {
  Mode = "local"
}
```

ã¾ãŸã€`country-api`ã¨ã„ã†ãƒ«ãƒ¼ãƒ†ã‚¤ãƒ³ã‚°ã‚µãƒ¼ãƒ“ã‚¹ã‚’ç™»éŒ²ã—ã€L7ã§ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’è¨­å®šã—ã¦ã„ã¾ã™ã€‚

```hcl
Kind = "service-router"
Name = "country-api"
Routes = [
  {
    match = {
      http = {
    path_prefix = "/api/japan"
      }
  }
    destination = {
      service = "japan"
    }
  },

  {
    match = {
      http = {
    path_prefix = "/api/france"
      }
  }
    destination = {
      service = "france"
    }
  },
]
```

ã“ã“ã§æŒ‡å®šã—ãŸ`country-api`ãŒ`corpx`ã‚¢ãƒ—ãƒªã®è¨­å®šã§æŒ‡å®šã•ã‚Œã¦ã„ã¾ã™ã€‚

```yaml
 annotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "9102"
    consul.hashicorp.com/connect-inject: "true"
    consul.hashicorp.com/connect-service-upstreams: "country-api:5000:dc-2"
```

ã“ã®è¨­å®šã‚’è¡Œã†ã“ã¨ã§`api/japan`ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã¯`japan`ã¸ã€`api/france`ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã¯`france`ã¸ä»²ä»‹ã•ã‚Œã¾ã™ã€‚

ä»Šå›ã¯Pathãƒ™ãƒ¼ã‚¹ã§ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®ã¿è¡Œã„ã¾ã—ãŸãŒã€L7 Traffic Managementã§ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªã“ã¨ã‚‚ã§ãã¾ã™ã€‚

* HTTP Header, Parameterãƒ™ãƒ¼ã‚¹ã§ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
* ã‚µãƒ¼ãƒ“ã‚¹ã®é‡ã¿ä»˜ã‘ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
* L7ãƒ™ãƒ¼ã‚¹ã®ACL
* åˆ¥ãƒ‡ãƒ¼ã‚¿ã‚»ãƒ³ã‚¿ãƒ¼ã¸ã®Failover

## Ingress Gatewayã§ã®ã‚µãƒ¼ãƒ“ã‚¹æ¥ç¶š

æœ€å¾Œã«Ingress Gatewayã®ã‚µãƒ¼ãƒ“ã‚¹ã®è¨­å®šã§ã™ã€‚`ui` - `hashicorpx`é–“ã§ã™ã€‚
`ui`ã‚¢ãƒ—ãƒªã¯PaaSä¸Šã«ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã€ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚’å…¥ã‚Œã‚‹äº‹ã¯å‡ºæ¥ã¾ã›ã‚“ã€‚ã“ã®ã‚ˆã†ãªã‚µãƒ¼ãƒ“ã‚¹ã‹ã‚‰ãƒ¡ãƒƒã‚·ãƒ¥ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã«ã‚¢ã‚¯ã‚»ã‚¹ã•ã›ã‚‹ã«ã¯Ingress Gatewayã‚’åˆ©ç”¨ã—ã¾ã™ã€‚

ã¾ãšã¯PaaSã«UIã®ã‚¢ãƒ—ãƒªã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã—ã‚‡ã†ã€‚
```shell script
$ git clone https://github.com/tkaburagi/mesh-ui
$ cd mesh-ui
$ ./mvnw clean package -DskipTests
```

`manifest.yaml`ã‚’é–‹ãã€ä»¥ä¸‹ã®ã‚ˆã†ã«ç·¨é›†ã—ã¾ã™ã€‚

```yaml
---
applications:
- name: mesh-ui
  buildpacks:
  - java_buildpack
env:
  ingress_url: <INGRESS_GATEWAY_IP>:<PORT>
```

ã“ã“ã‹ã‚‰å–å¾—ã—ã¦ãã ã•ã„ã€‚ã“ã®å ´åˆã ã¨`35.224.90.180:8080`ã§ã™ã€‚

```console
$ kubectl get svc -n=multicluster-sevicemesh

NAME                          TYPE           CLUSTER-IP    EXTERNAL-IP      PORT(S)                                                                   AGE
consul-connect-injector-svc   ClusterIP      10.0.45.94    <none>           443/TCP                                                                   21h
consul-dns                    ClusterIP      10.0.44.210   <none>           53/TCP,53/UDP                                                             21h
consul-ingress-gateway        LoadBalancer   10.0.39.98    35.224.90.180    8080:30948/TCP,8443:30402/TCP                                             21h
consul-mesh-gateway           LoadBalancer   10.0.36.69    104.198.41.205   443:32459/TCP                                                             21h
consul-server                 ClusterIP      None          <none>           8501/TCP,8301/TCP,8301/UDP,8302/TCP,8302/UDP,8300/TCP,8600/TCP,8600/UDP   21h
consul-ui                     LoadBalancer   10.0.44.251   35.223.84.7      443:32287/TCP                                                             21h
hashicorpx-lb                 LoadBalancer   10.0.42.124   35.238.100.171   8080:30637/TCP                                                            20h
```

```shell script
$ git clone https://github.com/tkaburagi/mesh-ui
$ ./mvnw clean package -DskipTests
$ cf push mesh-ui --random-route -p target/demo-0.0.1-SNAPSHOT.jar
```

`https://mesh-ui-<randome-route>.cfapps.io`ã®ã‚ˆã†ãªURLãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚ä»Šã®çŠ¶æ…‹ã ã¨ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã‚‚ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã¯ãšã§ã™ã€‚

### Ingress Gatewayã®è¨­å®š

Ingress Gatewayã‚’ã™ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸€ã¤è¿½åŠ ã™ã‚‹ã ã‘ã§ã™ã€‚

```shell script
$ consul config write proxy-config/hcx-svc-router.hcl
$ consul config write ingress-gateway/ingress-gateway.hcl
```

```hcl
Kind = "ingress-gateway"
Name = "ingress-gateway"

Listeners = [
  {
    Port     = 8080
    Protocol = "http"
    Services = [
      {
        Name  = "hashicorpx"
      }
    ]
  }
]
```

ã“ã‚Œã§Ingress Gatewayã‚’ä»‹ã—ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒ`hashicorpx`ã¸ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã•ã‚Œã¾ã™ã€‚ã‚¢ãƒ—ãƒªã®ã‚½ãƒ¼ã‚¹ã¯ã“ã‚“ãªæ„Ÿã˜ã§ã™ã€‚

```java
@Controller
public class UiController {

    private final RestTemplate restTemplate;
    private static final String protocol = "http://";
    private static final String ingresshost = "hashicorpx.ingress.dc-1.consul:8080";

    public UiController(RestTemplateBuilder builder) {
        this.restTemplate = builder.build();
    }

    @Value( "${ingress_url}" )
    private String ingress_url;

    @GetMapping(value = "/japan")
    public String japan(Model model) {
        ResponseEntity<String> response =
                this.restTemplate.exchange(protocol + ingress_url + "/japan",
                        HttpMethod.GET,
                        new HttpUtil().setEntiry(ingresshost),
                        String.class);
        model.addAttribute("message", response.getBody() + " ğŸ‡¯ğŸ‡µ");
        return "ui/index";
    }

    @GetMapping(value = "/france")
    public String france(Model model) {
        ResponseEntity<String> response =
                this.restTemplate.exchange(protocol + ingress_url + "/france",
                        HttpMethod.GET,
                        new HttpUtil().setEntiry(ingresshost),
                        String.class);
        model.addAttribute("message", response.getBody() + " ğŸ‡«ğŸ‡·");
        return "ui/index";
    }
}
```

ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹å…ˆã¯Ingress Gatewayã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§ã™ã€‚HTTP Headerã«ã‚µãƒ¼ãƒ“ã‚¹åãƒ™ãƒ¼ã‚¹ã®ãƒ›ã‚¹ãƒˆåã‚’æŒ‡å®šã—ã¾ã™ã€‚

Ingress Gatewayã¯ã‚¢ã‚¯ã‚»ã‚¹å…ˆã¯Ingress Gatewayè‡ªä½“ã§ã€HTTP Headerã‚’ãƒ™ãƒ¼ã‚¹ã«`<service_name>.ingress.<dc_name>.consul`ã®ã‚ˆã†ãªãƒ›ã‚¹ãƒˆåã‚’æŒ‡å®šã™ã‚‹äº‹ã§ã€Consulã®DNSã‚¤ãƒ³ã‚¿ãƒ•ã‚§ãƒ¼ã‚¹ã‚’ä»‹ã—ã¦å®Ÿéš›ã®ã‚µãƒ¼ãƒ“ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™ã€‚

ä»¥ä¸Šã§çµ‚äº†ã§ã™ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã§ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ã“ã‚“ãªæ„Ÿã˜ã«ãªã‚‹ã¯ãšã€‚

* `https://mesh-ui-<random-route>.cfapps.io/japan`

<kbd>
  <img src="https://github-image-tkaburagi.s3-ap-northeast-1.amazonaws.com/my-github-repo/japan.png">
</kbd>

* `https://mesh-ui-<random-route>.cfapps.io/france`

<kbd>
  <img src="https://github-image-tkaburagi.s3-ap-northeast-1.amazonaws.com/my-github-repo/france.png">
</kbd>


## å‚è€ƒãƒªãƒ³ã‚¯
* [Consul Helm Chart Configuration](https://www.consul.io/docs/k8s/helm)
* [Multi Cluster Federation](https://www.consul.io/docs/k8s/installation/multi-cluster)
* [Federation Between K8s Clusters](https://www.consul.io/docs/k8s/installation/multi-cluster/kubernetes)
* [Consul Connect Configuration Entries](https://www.consul.io/docs/connect/config-entries)
* [ã‚¢ãƒ—ãƒªã®ãƒ¬ãƒ](https://github.com/tkaburagi/consul-intentions-demo)
* [L7 Traffic Management](https://www.consul.io/docs/connect/l7-traffic)
* 